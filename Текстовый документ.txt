# OrderlyVerse ‚Äî YouTube Auto-Organizer (MVP)
# –ó–∞–ø—É—Å–∫: uvicorn main:app --reload --port 8000
# –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞: REDIRECT_URI = "http://localhost:8000/auth/callback"

from fastapi import FastAPI, Request, HTTPException
from fastapi.responses import RedirectResponse, HTMLResponse
from google_auth_oauthlib.flow import Flow
from googleapiclient.discovery import build
import os
import json

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
CLIENT_SECRETS_FILE = "client_secrets.json"
SCOPES = ["https://www.googleapis.com/auth/youtube"]
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ localhost –¥–ª—è —Ç–µ—Å—Ç–∞, –≤–∞—à URL ‚Äî –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
REDIRECT_URI = os.getenv("REDIRECT_URI", "http://localhost:8000/auth/callback")

app = FastAPI()

@app.get("/")
async def home():
    return HTMLResponse('''
    <h2>OrderlyVerse ‚Äî –ü–æ–¥–∫–ª—é—á–∏—Ç–µ YouTube –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º</h2>
    <a href="/connect">üëâ –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∞–Ω–∞–ª</a>
    ''')

@app.get("/connect")
async def connect():
    if not os.path.exists(CLIENT_SECRETS_FILE):
        raise HTTPException(500, "–§–∞–π–ª client_secrets.json –Ω–µ –Ω–∞–π–¥–µ–Ω")
    flow = Flow.from_client_secrets_file(
        CLIENT_SECRETS_FILE,
        scopes=SCOPES,
        redirect_uri=REDIRECT_URI
    )
    auth_url, _ = flow.authorization_url(prompt="consent")
    return RedirectResponse(auth_url)

@app.get("/auth/callback")
async def auth_callback(code: str = None):
    if not code:
        return HTMLResponse("‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏", status_code=400)

    flow = Flow.from_client_secrets_file(
        CLIENT_SECRETS_FILE,
        scopes=SCOPES,
        redirect_uri=REDIRECT_URI
    )
    flow.fetch_token(code=code)
    credentials = flow.credentials

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ YouTube
    youtube = build("youtube", "v3", credentials=credentials)

    # –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ
    videos = []
    next_page = None
    for _ in range(2):  # –º–∞–∫—Å. 100 –≤–∏–¥–µ–æ –¥–ª—è MVP
        req = youtube.search().list(
            part="snippet",
            maxResults=50,
            pageToken=next_line,
            type="video",
            order="date"
        )
        res = req.execute()
        videos.extend(res["items"])
        next_page = res.get("nextPageToken")
        if not next_page:
            break

    # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è)
    poets = ["–ê—Ö–º–∞—Ç–æ–≤–∞", "–¶–≤–µ—Ç–∞–µ–≤–∞", "–ü—É—à–∫–∏–Ω", "–ë–ª–æ–∫", "–ï—Å–µ–Ω–∏–Ω"]
    playlists_to_create = {poet: [] for poet in poets}

    for video in videos:
        title = video["snippet"]["title"]
        for poet in poets:
            if poet in title:
                playlists_to_create[poet].append(video["id"]["videoId"])

    # –°–æ–∑–¥–∞—ë–º –ø–ª–µ–π–ª–∏—Å—Ç—ã
    created = []
    for poet, video_ids in playlists_to_create.items():
        if not video_ids:
            continue
        pl = youtube.playlists().insert(
            part="snippet,status",
            body={
                "snippet": {"title": f"üìö {poet}"},
                "status": {"privacyStatus": "private"}
            }
        ).execute()
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ 5 –≤–∏–¥–µ–æ (YouTube –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: 5 –∑–∞ –∑–∞–ø—Ä–æ—Å –±–µ–∑ batch)
        for vid in video_ids[:5]:
            youtube.playlistItems().insert(
                part="snippet",
                body={
                    "snippet": {
                        "playlistId": pl["id"],
                        "resourceId": {"videoId": vid, "kind": "youtube#video"}
                    }
                }
            ).execute()
        created.append(poet)

    # –§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
    return HTMLResponse(f'''
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <title>–ì–æ—Ç–æ–≤–æ! ‚Äî OrderlyVerse</title>
        <style>
            body {{ background: #0B0B1A; color: white; font-family: 'PT Serif', serif; text-align: center; padding: 10vh; }}
            .btn {{ background: linear-gradient(135deg, #D4AF37, #B8860B); color: white; border: none; padding: 12px 24px; margin: 10px; border-radius: 4px; text-decoration: none; display: inline-block; }}
        </style>
    </head>
    <body>
        <div style="font-size: 48px;">‚ú®</div>
        <h1>–ü–æ—Ä—è–¥–æ–∫ —Å–æ–∑–¥–∞–Ω!</h1>
        <p>–°–æ–∑–¥–∞–Ω—ã –ø–ª–µ–π–ª–∏—Å—Ç—ã: {" ¬∑ ".join(created) if created else "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∏–¥–µ–æ"}</p>
        <a href="https://youtube.com" class="btn">–û—Ç–∫—Ä—ã—Ç—å YouTube</a>
        <p><small>OrderlyVerse ¬© 2025 ‚Äî –•–∞–æ—Å —Å—Ç–∞–ª –ø–æ—ç–∑–∏–µ–π.</small></p>
    </body>
    </html>
    '''){
  "web": {
    "client_id": "–í–ê–®_CLIENT_ID.apps.googleusercontent.com",
    "project_id": "orderlyverse-XXXXX",
    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
    "token_uri": "https://oauth2.googleapis.com/token",
    "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
    "client_secret": "–í–ê–®_CLIENT_SECRET",
    "redirect_uris": ["http://localhost:8000/auth/callback"]
  }
}